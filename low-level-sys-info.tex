%%% vim:ai:tw=72:
\chapter{Low Level System Information}

This section describes the low-level system information for the
\xARCH System V ABI.

\section{Machine Interface}

The \xARCH processor architecture and data representation are covered in
this section.

\subsection{Data Representation}
\label{data_representation}

Within this specification, the term \emph{\textindex{\byte{}}} refers to
a 8-bit object, the term \emph{\textindex{\twobyte{}}} refers to a 16-bit
object, the term \emph{\textindex{\fourbyte{}}} refers to a 32-bit
object, the term \emph{\textindex{\eightbyte{}}} refers to a 64-bit
object, and the term \emph{\textindex{\sixteenbyte{}}} refers to a
128-bit object.%
\footnote{The \intelabi uses the term \emph{\textindex{halfword}} for
  a 16-bit object, the term \emph{\textindex{word}} for a 32-bit
  object, the term \emph{\textindex{doubleword}} for a 64-bit object.  But
  most IA-32 processor specific documentation define a
  \emph{\textindex{word}} as a 16-bit object, a
  \emph{\textindex{doubleword}} as a 32-bit object, a
  \emph{\textindex{quadword}} as a 64-bit object and a
  \emph{\textindex{double quadword}} as a 128-bit object.}

\subsubsection{Fundamental Types}

Table~\ref{basic-types} shows the correspondence between ISO C
scalar types and the processor scalar types.  \code{__float80},
\code{__float128}, \code{__m64}, \code{__m128}, \code{__m256} and
\code{__m512} types are optional.

\begin{table}
  \caption{Scalar Types}\label{basic-types}
{ % Use small here - the table is still too large
  % Has anybody an idea how to shrink the table so that it fits the page?
  \myfontsize
  \begin{tabular}{l|l|c|c|l}
    \hline\noalign{\smallskip}
     & &  & \multicolumn{1}{c|}{Alignment} & \multicolumn{1}{c|}{\xARCH} \\
    \multicolumn{1}{c|}{Type} & \multicolumn{1}{c|}{C}
     &  \texttt{sizeof} & (bytes)
     & \multicolumn{1}{c|}{Architecture}  \\
    \hline
    & \texttt{_Bool}$^\dagger$ & 1 & 1 & boolean \\
    \cline{2-5}
    & \texttt{char}        & 1 & 1 & signed byte \\
    & \texttt{signed char} & & \\
    \cline{2-5}
    & \texttt{unsigned char} & 1 & 1 & unsigned byte \\
    \cline{2-5}
    & \texttt{short} & 2 & 2 & signed \twobyte \\
    & \texttt{signed short} & & \\
    \cline{2-5}
    & \texttt{unsigned short} & 2 & 2 & unsigned \twobyte \\
    \cline{2-5}
    & \texttt{int} & 4 & 4 & signed \fourbyte \\
    Integral & \texttt{signed int} & & \\
    & \texttt{enum}$^{\dagger\dagger\dagger}$ & & \\
    \cline{2-5}
    & \texttt{unsigned int} & 4 & 4 & unsigned \fourbyte \\
    \cline{2-5}
    & \texttt{long} & 4 & 4 & signed \fourbyte \\
    & \texttt{signed long} & & \\
    \cline{2-5}
    & \texttt{unsigned long} & 4 & 4 & unsigned \fourbyte \\
    \cline{2-5}
    & \texttt{long long} & 8 & 4 & signed \eightbyte \\
    & \texttt{signed long long} & & \\
    \cline{2-5}
    & \texttt{unsigned long long} & 8 & 4 & unsigned \eightbyte \\
    \cline{2-5}
    \hline
    Pointer
    & \texttt{\textit{any-type} *} & 4 & 4 & unsigned \fourbyte \\
    & \texttt{\textit{any-type} (*)()} & & \\
    \hline
    Floating-& \texttt{float} & 4 & 4 & single (IEEE-754) \\
    \cline{2-5}
    point & \texttt{double} & 8 & 4 & double (IEEE-754) \\
    & \texttt{long double}$^{\dagger\dagger\dagger\dagger}$  & & & \\
    \cline{2-5}
    & \texttt{__float80}$^{\dagger\dagger}$  & 12 & 4 & 80-bit extended (IEEE-754) \\
    & \texttt{long double}$^{\dagger\dagger\dagger\dagger}$  & & & \\
    \cline{2-5}
    & \texttt{__float128}$^{\dagger\dagger}$ & 16 & 16 & 128-bit extended (IEEE-754) \\
    \hline
    Complex& \texttt{_Complex float} & 8 & 4 & complex single (IEEE-754) \\
    \cline{2-5}
    Floating-& \texttt{_Complex double} & 16 & 4 & complex double (IEEE-754) \\
    point & \texttt{_Complex long double}$^{\dagger\dagger\dagger\dagger}$ & & & \\
    \cline{2-5}
    & \texttt{_Complex __float80}$^{\dagger\dagger}$  & 24 & 4 & complex 80-bit extended (IEEE-754) \\
    & \texttt{_Complex long double}$^{\dagger\dagger\dagger\dagger}$  & & & \\
    \cline{2-5}
    & \texttt{_Complex __float128}$^{\dagger\dagger}$ & 32 & 16 & complex 128-bit extended (IEEE-754) \\
    \hline
    Decimal-& \texttt{_Decimal32} & 4 & 4 & 32bit BID (IEEE-754R) \\
    \cline{2-5}
    floating-& \texttt{_Decimal64} & 8 & 8 & 64bit BID (IEEE-754R) \\
    \cline{2-5}
    point & \texttt{_Decimal128} & 16 & 16 & 128bit BID (IEEE-754R) \\
    \hline
    Packed & \texttt{__m64}$^{\dagger\dagger}$ & 8 & 8 & \MMX{} and \threednow \\
    \cline{2-5}
    & \texttt{__m128}$^{\dagger\dagger}$ & 16 & 16 & SSE and SSE-2 \\
    \cline{2-5}
    & \texttt{__m256}$^{\dagger\dagger}$ & 32 & 32 & AVX \\
    \cline{2-5}
    & \texttt{__m512}$^{\dagger\dagger}$ & 64 & 64 & AVX-512 \\
\noalign{\smallskip}
\cline{1-5}
\multicolumn{3}{l}{\small $^\dagger$ This type is called \texttt{bool}
in C++.}\\
\multicolumn{3}{l}{\small $^{\dagger\dagger}$ These types are optional.}\\
\multicolumn{5}{p{14cm}}{\small $^{\dagger\dagger\dagger}$ C++ and some
implementations of C permit enums larger than an int.  The underlying
type is bumped to an unsigned int.}\\
\multicolumn{5}{p{14cm}}{\small $^{\dagger\dagger\dagger\dagger}$
The \texttt{long double} type is 64-bit, the same as the \texttt{double}
type, on the Android{\texttrademark} platform.  More information on the
Android{\texttrademark} platform is available from
\url{http://www.android.com/}.}\\
  \end{tabular}
}
\end{table}

The 128-bit floating-point type uses a 15-bit exponent, a 113-bit
mantissa (the high order significant bit is implicit) and an exponent
bias of 16383.\footnote{Initial implementations of the \xARCH
  architecture are expected to support operations on the
  128-bit floating-point  type only via software emulation.}

The 80-bit floating-point type uses a 15 bit exponent, a 64-bit mantissa
with an explicit high order significant bit and an exponent bias of
16383.\footnote{This type is the x87 double extended precision data
  type.} 

A null pointer (for all types) has the value zero.

The type \codeindex{size\_t} is defined as \code{unsigned int}.

Booleans\index{boolean}, when stored in a memory object, are stored as
single byte objects the value of which is always 0 (\code{false}) or 1
(\code{true}).  When stored in integer registers (except for passing
as arguments), all 4 bytes of the register are significant;
any nonzero value is considered \code{true}.

\begin{sloppypar}
The \xARCH architecture in general
does not require all data accesses to be properly aligned.  Misaligned
data accesses may be slower than aligned accesses
but otherwise behave identically.  The only exceptions are that
\code{__float128}, \code{_Complex __float128},  \code{_Decimal128},
\code{__m128}, \code{__m256} and \code{__m512} must always be aligned
properly.
\end{sloppypar}

\subsubsection{Structures and Unions}

Structures and unions assume the alignment of their most strictly
aligned component.  Each member is assigned to the lowest available
offset with the appropriate alignment.  The size of any object is always
a multiple of the object`s alignment.

Structure and union objects can require padding to meet size and
alignment constraints.  The contents of any padding is undefined.

%%% SUN <examples - add diagrams>

\section{Function Calling Sequence}

This section describes the standard function calling sequence,
including stack frame layout, register usage, parameter passing and so
on.

The standard calling sequence requirements apply only to global
functions.  Local functions that are not reachable from other
compilation units may use different conventions.  Nevertheless, it is
recommended that all functions use the standard calling sequence when
possible.

\subsection{Registers}
\label{subsec-registers}

The \xARCH architecture provides 8 general purpose 32-bit registers.
In addition the architecture provides 8 SSE registers, each 128 bits
wide and 8 x87 floating point registers, each 80 bits wide.  Each of
the x87 floating point registers may be referred to in \MMX
mode as a 64-bit register.  All of these registers are global to all
procedures active for a given thread.

Intel AVX (Advanced Vector Extensions) provides 8 256-bit wide AVX registers
(\reg{ymm0} - \reg{ymm7}).  The lower 128-bits of \reg{ymm0} - \reg{ymm7}
are aliased to the respective 128b-bit SSE registers (\reg{xmm0} -
\reg{xmm7}).  Intel AVX-512 provides 8 512-bit wide SIMD registers
(\reg{zmm0} - \reg{zmm7}).  The lower 128-bits of \reg{zmm0} - \reg{zmm7}
are aliased to the respective 128b-bit SSE registers
(\reg{xmm0} - \reg{xmm7}).
The lower 256-bits of \reg{zmm0} - \reg{zmm7}
are aliased to the respective 256-bit AVX registers
(\reg{ymm0} - \reg{ymm7}).
For purposes of parameter passing
and function return, \reg{xmmN}, \reg{ymmN} and \reg{zmmN} refer to the
same register. Only one of them can be used at the same time.  We use
vector register to refer to either SSE, AVX or AVX-512 register.  In
addition, Intel AVX-512 also provides 8 vector mask registers (\reg{k0}
- \reg{k7}), each 64-bit wide.

The CPU shall be in x87 mode upon entry to a function.  Therefore,
every function that uses the \MMX registers is required to issue an
\op{emms} or \op{femms} instruction after using \MMX registers, before
returning or calling another function.  \footnote{All x87 registers
are caller-saved, so callees that make use of the \MMX registers may
use the faster \op{femms} instruction.}  The direction flag \code{DF} in the
\reg{EFLAGS} register must be clear (set to ``forward'' direction) on function
entry and return.  Other user flags have no specified role in the
standard calling sequence and are {\em not} preserved across calls.

The control bits of the \code{MXCSR} register are callee-saved
(preserved across calls), while the status bits are caller-saved (not
preserved).  The x87 status word register is caller-saved, whereas
the x87 control word is callee-saved.

\subsection{The Stack Frame}
\label{sec-stack-frame}

In addition to registers, each function has a frame on the run-time
stack.  This stack grows downwards from high addresses.  Table~
\ref{fig-stack-frame} shows the stack organization.

\begin{table}
\Hrule
  \caption{Stack Frame with Base Pointer}
  \label{fig-stack-frame}
  \begin{center}
    \begin{tabular}{r|c|l}
      \noalign{\smallskip}
      \multicolumn{1}{l}{Position} &
      \multicolumn{1}{c}{Contents} &
      \multicolumn{1}{l}{Frame} \\
      \noalign{\smallskip}  \cline{1-3}
      \code{4n+8(\EBP)} & memory argument \fourbyte $n$ \\
      & \dots & Previous \\
      \code{8(\EBP)} & memory argument \fourbyte $0$ \\
      \cline{1-3}
      \code{4(\EBP)} & return address \\ \cline{2-2}
      \code{0(\EBP)} & previous \EBP value \\
      \cline{2-2}
      \code{-4(\EBP)} & unspecified & Current \\
      & \dots & \\
      \code{0(\ESP)} & variable size \\
    \end{tabular}
  \end{center}
\Hrule
\end{table}

The end of the input argument area shall be aligned on a 16 (32 or 64, if
\texttt{__m256} or \texttt{__m512} is passed on stack) byte boundary.
In other words, the value $(\ESP + 4)$ is always a multiple of $16$
($32$ or $64$) when
control is transferred to the function entry point.  The
stack pointer, \ESP, always points to the end of the latest allocated
stack frame.  \footnote{The conventional use of \EBP{} as a frame
  pointer for the stack frame may be avoided by using \ESP (the stack
  pointer) to index into the stack frame.  This technique saves two
  instructions in the prologue and epilogue and makes one additional
  general-purpose register (\EBP) available.}

\subsection{Parameter Passing and Returning Values}
\label{sec-calling-conventions}

After the argument values have been computed, they are placed either in
registers or pushed on the stack.

\subsubsection{Empty Type}

\texttt{Empty type} is defined as a trivially-copyable aggregate
occupying zero bytes (excluding any padding).  No memory slot nor
register should be used to pass or return an object object of
\texttt{empty type} \footnote{Array of \texttt{empty type} can only
passed by reference in C and C++.}.

\subsubsection{Passing Parameters}

Most parameters are passed on the stack. Parameters are pushed onto the
stack in reverse order - the last argument in the parameter list has the
highest address, that is, it is stored farthest away from the stack pointer
at the time of the call.

Padding may be needed to increase the size of each parameter to enforce
alignment according to the values in Table~\ref{basic-types}.  There is
an exception for \texttt{__m64} and \texttt{_Decimal64}, which are treated
as having an
alignment of four for the purposes of parameter passing.  Additional
padding may be necessary to ensure that the bottom of the parameter block
(closest to the stack pointer) is at an address which is \code{0 mod 16},
to guarantee proper alignment to the callee.

The exceptions to parameters passed on stack are as follows:
\begin{itemize}
  \item The first three parameters of type \texttt{__m64} are passed in
	\reg{mm0}, \reg{mm1}, and \reg{mm2}.
  \item The first three parameters of type \texttt{__m128} are passed in
	\reg{xmm0}, \reg{xmm1}, and \reg{xmm2}.\footnote{The SSE, AVX
	and AVX-512 registers share resources. Therefore, if the first
	\texttt{__m128} parameter gets assigned to \reg{xmm0} , the
	first \texttt{__m256}/\texttt{__m512} parameter after that is
	assigned to \reg{ymm1}/\reg{zmm1} and not
	\reg{ymm0}/\reg{zmm0}.}
\end{itemize}

If parameters of type \texttt{__m256} are required to be passed on the
stack, the stack pointer must be aligned on a \code{0 mod 32} byte boundary
at the time of the call.

If parameters of type \texttt{__m512} are required to be passed on the
stack, the stack pointer must be aligned on a \code{0 mod 64} byte boundary
at the time of the call.

\begin{table}
\Hrule
  \caption{Register Usage}
  \label{fig-reg-usage}
  \begin{center}
    \begin{tabular}{l|p{8.35cm}|l}
      \noalign{\smallskip}
      \multicolumn{1}{c}{} &
      \multicolumn{1}{c}{}&
      \multicolumn{1}{l}{Preserved across}\\
      \multicolumn{1}{c}{Register} &
      \multicolumn{1}{c}{Usage}&
      \multicolumn{1}{l}{function calls}\\
      \hline
\EAX & scratch register; also used to return integer and
pointer values from functions; also stores the address of a
returned struct or union & No \\
\EBX & callee-saved register; also used to hold the GOT pointer when
making function calls via the PLT & Yes \\
\ECX & scratch register & No \\
\EDX & scratch register; also used to return the upper 32bits
of some 64bit return types & No \\
\ESP & stack pointer & Yes \\
\EBP & callee-saved register; optionally used as frame pointer & Yes \\
\ESI & callee-saved register & yes \\
\EDI & callee-saved register & yes \\
\reg{xmm0}, \reg{ymm0} & scratch registers; also used to pass and return
\code{__m128}, \code{__m256} parameters & No\\
\reg{xmm1}--\reg{xmm2},& scratch registers; also used to pass
\code{__m128}, & No \\
\reg{ymm1}--\reg{ymm2} & \code{__m256} parameters & \\
\reg{xmm3}--\reg{xmm7},& scratch registers & No \\
\reg{ymm3}--\reg{ymm7} & & \\
\reg{mm0} & scratch register; also used to pass and return
\code{__m64} parameter & No\\
\reg{mm1}--\reg{mm2} & used to pass \code{__m64} parameters & No\\
\reg{mm3}--\reg{mm7}& scratch registers & No\\
\reg{k0}--\reg{k7} & scratch registers & No \\
\reg{st0} & scratch register; also used to return \code{float},
\code{double}, \code{long double}, \code{__float80} parameters & No \\
\reg{st1}--\reg{st7} & scratch registers & No \\
\reg{gs}& Reserved for system (as thread specific data register) & No\\
\code{mxcsr}& SSE2 control and status word & partial\\
\code{x87 SW}& x87 status word & No\\
\code{x87 CW}& x87 control word & Yes\\
    \end{tabular}

  \end{center}
\Hrule
\end{table}

\subsubsection{Returning Values}

Table~\ref{fig_returning_locations} lists the location used to return a
value for each fundamental data type.  Aggregate types (\texttt{structs}
and \texttt{unions}) are always returned in memory.

\begin{table}
  \caption{Return Value Locations for Fundamental Data Types}
  \label{fig_returning_locations}
{ % Use small here - the table is still too large
  % Has anybody an idea how to shrink the table so that it fits the page?
  \myfontsize
  \begin{tabular}{l|l|l}
    \hline\noalign{\smallskip}
    \multicolumn{1}{c|}{Type} & \multicolumn{1}{c|}{C}
     & \multicolumn{1}{c}{Return Value Location} \\
    \hline
    & \texttt{_Bool}       & \reg{al} \\
    & \texttt{char}        & The upper 24 bits of \EAX are undefined. The
    caller must not \\
    & \texttt{signed char} & rely on these being set in a predefined way
    by the called \\
    & \texttt{unsigned char} & function. \\
    \cline{2-3}
    & \texttt{short} & \reg{ax} \\
    & \texttt{signed short} & The upper 16 bits of \EAX are undefined.
    The caller must not \\
    & \texttt{unsigned short} & rely on these being set in a predefined
    way by the called function. \\
    \cline{2-3}
    & \texttt{int} & \EAX \\
    Integral & \texttt{signed int} & \\
    & \texttt{enum} \\
    & \texttt{unsigned int} & \\
    & \texttt{long} &  \\
    & \texttt{signed long} & \\
    & \texttt{unsigned long} & \\
    \cline{2-3}
    & \texttt{long long} & \EDX:\EAX \\
    & \texttt{signed long long} & The most significant 32 bits are
    returned in \EDX. The least \\
    & \texttt{unsigned long long} & significant 32 bits are returned in
    \EAX. \\
    \cline{2-3}
    \hline
    Pointer
    & \texttt{\textit{any-type} *} & \EAX \\
    & \texttt{\textit{any-type} (*)()} & \\
    \hline
    & \texttt{float} & \reg{st0} \\
    \cline{2-3}
    Floating- & \texttt{double} & \reg{st0} \\
    \cline{2-3}
    point & \texttt{long double} & \reg{st0} \\
    \cline{2-3}
    & \texttt{__float80} & \reg{st0} \\
    \cline{2-3}
    & \texttt{__float128} & memory \\
    \hline
    & \texttt{_Complex float} & \EDX:\EAX \\
    & & The real part is returned in \EAX. The imaginary part is
        returned \\
    Complex & & in \EDX.\\
    \cline{2-3}
    floating- & \texttt{_Complex double} & memory \\
    \cline{2-3}
    point & \texttt{_Complex long double} & memory \\
    \cline{2-3}
    & \texttt{_Complex __float80} & memory \\
    \cline{2-3}
    & \texttt{_Complex __float128} & memory \\
    \hline
    & \texttt{_Decimal32} & \EAX \\
    \cline{2-3}
    Decimal-& \texttt{_Decimal64} & \EDX:\EAX \\
    floating- & & The most significant 32 bits are returned in \EDX.
                  The least\\
    point & & significant 32 bits are returned in \EAX.\\
    \cline{2-3}
    & \texttt{_Decimal128} & memory \\
    \hline
    & \texttt{__m64} & \reg{mm0} \\
    \cline{2-3}
    Packed & \texttt{__m128} & \reg{xmm0} \\
    \cline{2-3}
    & \texttt{__m256} & \reg{ymm0} \\
    \cline{2-3}
    & \texttt{__m512} & \reg{zmm0} \\
\noalign{\smallskip}
\cline{1-3}
  \end{tabular}
}
\end{table}

Functions that return scalar floating-point values in registers return
them on the top of the x87 register stack, that is, \reg{st0}. It is the
responsibility of the calling function to pop this value from the stack
regardless of whether or not the value is actually used.  Failure to do so
results in undefined behavior.  An implication of this requirement is that
functions returning scalar floating-point values must be properly
prototyped.  Again, failure to do so results in undefined behavior.

\subsubsection{Returning Values in Memory}

Some fundamental types and all aggregate types are returned in memory.
For functions that return a value in memory, the caller passes a pointer
to the memory location where the called function must write the return
value. This pointer is passed to called function as an implicit first
argument. The memory location must be properly aligned according to the
rules in section~\ref{data_representation}.  In addition to writing the
return value to the proper location, the called function is responsible
for popping the implicit pointer argument off the stack and storing it in
\EAX prior to returning. The calling function may choose to reference the
return value via \EAX after the function returns.

As an example of the register passing conventions, consider the
declarations and the function call shown in
Table~\ref{fig_passing_example}.  The corresponding register
allocation is given in Table~\ref{fig_allocation_example}, the stack
frame layout given in Table~\ref{fig_stack_frame_layout} shows the frame
before calling the function.

\begin{table}[H]
\Hrule
\caption{Parameter Passing Example}
\label{fig_passing_example}
\begin{center}
\code{
\begin{tabular}{|l|}
\cline{1-1}
typedef struct \{ \\
\ \ int a, b;\\
\ \ double d;\\
\} structparm;\\
structparm s;\\
int i;\\
__m128 v, x, y;\\
__m256 w, z;\\
\\
extern structparm func (int i, __m128 v,\\
\phantom{extern structparm func (}structparm s, __m256 w,\\
\phantom{extern structparm func (}__m128 x, __m128 y,\\
\phantom{extern structparm func (}__m256 z);\\
\\
func (i, v, s, w, x, y, z);\\
\cline{1-1}
\end{tabular}
}
\end{center}
\Hrule
\end{table}

\begin{table}[H]
\Hrule
\caption{Register Allocation for Parameter Passing Example}
\label{fig_allocation_example}
\begin{center}
\begin{tabular}{c|r}
\multicolumn{1}{c}{Parameter} &
\multicolumn{1}{c}{Location before the call}\\
\hline
Return value pointer & (\ESP) \\
\code{i}             & 4(\ESP) \\
\code{v}             & \reg{xmm0} \\
\code{s}             & 8(\ESP) \\
\code{w}             & \reg{ymm1} \\
\code{x}             & \reg{xmm2} \\
\code{y}             & 32(\ESP) \\
\code{z}             & 64(\ESP) \\
\end{tabular}
\end{center}
\Hrule
\end{table}

\begin{table}[H]
\Hrule
\caption{Stack Layout at the Call}
\label{fig_stack_frame_layout}
\begin{center}
\begin{tabular}{|c|r|l}
\multicolumn{1}{c}{Contents} &
\multicolumn{1}{c}{Length}\\
\cline{1-2}
\code{z}             & 32 bytes &\\
\cline{1-2}
padding              & 16 bytes &\\
\cline{1-2}
\code{y}             & 16 bytes &\\
\cline{1-2}
padding              & 8 bytes  &\\
\cline{1-2}
\code{s}             & 16 bytes &\\
\cline{1-2}
\code{i}             & 4 bytes  &\\
\cline{1-2}
Return value pointer & 4 bytes  & $\longleftarrow$ \ESP (32-byte aligned)\\
\cline{1-2}
\end{tabular}
\end{center}
\Hrule
\end{table}

When a value of type \code{_Bool} is returned or passed in a register or
on the stack, bit 0 contains the truth value and bits 1 to 7 shall be
zero\footnote{Other bits are left unspecified, hence the consumer
side of those values can rely on it being 0 or 1 when truncated to 8
bit.}.

\subsection{Variable Argument Lists}

Some otherwise portable C programs depend on the argument passing
scheme, implicitly assuming that all arguments are passed on the
stack, and arguments appear in increasing order on the stack.
Programs that make these assumptions never have been portable, but
they have worked on many implementations. However, they do not work on
the \xARCH architecture because some arguments are passed in
registers.  Portable C programs must use the header file
\code{<stdarg.h>} in order to handle variable argument lists.

When a function taking variable-arguments is called, all parameters are
passed on the stack, including \texttt{__m64}, \texttt{__m128} and
\texttt{__m256}.  This rule applies to both named and unnamed parameters.
Because parameters are passed differently depending on whether or not the
called function takes a variable argument list, it is necessary for such
functions to be properly prototyped.  Failure to do so results in
undefined behavior.

\section{Process Initialization}

\subsection{Initial Stack and Register State}

\subsubsection{Special Registers}

The \xARCH architecture defines floating point instructions.  At
process startup the two floating point units, SSE2 and x87, both have
all floating-point exception status flags cleared.  The status of the
control words is as defined in tables~\ref{x87-fpucw} and
\ref{mxcsr-status}.

\begin{table}[H]
\Hrule
  \caption{x87 Floating-Point Control Word}
  \label{x87-fpucw}
  \begin{center}
    \begin{tabular}[t]{l|l|l}
      \multicolumn{1}{c}{Field} & \multicolumn{1}{c}{Value}& \multicolumn{1}{c}{Note} \\
      \hline
      \texttt{RC} & 0 & Round to nearest\\
      \texttt{PC} & 11& Double extended precision\\
      \texttt{PM} & 1 & Precision masked\\
      \texttt{UM} & 1 & Underflow masked\\
      \texttt{OM} & 1 & Overflow masked\\
      \texttt{ZM} & 1 & Zero divide masked\\
      \texttt{DM} & 1 & De-normal operand masked\\
      \texttt{IM} & 1 & Invalid operation masked\\
    \end{tabular}
  \end{center}
\Hrule
\end{table}

\begin{table}[H]
\Hrule
  \caption{MXCSR Status Bits}
  \label{mxcsr-status}
  \begin{center}
    \begin{tabular}[t]{l|l|l}
      \multicolumn{1}{c}{Field} & \multicolumn{1}{c}{Value}& \multicolumn{1}{c}{Note} \\
      \hline
      \texttt{FZ}  & 0 & Do not flush to zero\\
      \texttt{RC}  & 0 & Round to nearest\\
      \texttt{PM}  & 1 & Precision masked\\
      \texttt{UM}  & 1 & Underflow masked\\
      \texttt{OM}  & 1 & Overflow masked\\
      \texttt{ZM}  & 1 & Zero divide masked\\
      \texttt{DM}  & 1 & De-normal operand masked\\
      \texttt{IM}  & 1 & Invalid operation masked\\
      \texttt{DAZ} & 0 & De-normals are not zero\\
    \end{tabular}
  \end{center}
\Hrule
\end{table}

The \code{EFLAGS} register contains the system flags, such as the
direction flag and the carry flag.  The low 16 bits (FLAGS portion)
of \code{EFLAGS} are accessible by
application software.  The state of them at process initialization
is shown in table~\ref{eflags-status}.

\begin{table}[H]
\Hrule
  \caption{\code{EFLAGS} Bits}
  \label{eflags-status}
  \begin{center}
    \begin{tabular}[t]{l|l|l}
      \multicolumn{1}{c}{Field} & \multicolumn{1}{c}{Value}& \multicolumn{1}{c}{Note} \\
      \hline
      \texttt{DF} & 0 & Direction forward\\
      \texttt{CF} & 0 & No carry\\
      \texttt{PF} & 0 & Even parity\\
      \texttt{AF} & 0 & No auxiliary carry\\
      \texttt{ZF} & 0 & No zero result\\
      \texttt{SF} & 0 & Unsigned result\\
      \texttt{OF} & 0 & No overflow occurred\\
    \end{tabular}
  \end{center}
\Hrule
\end{table}

\subsubsection{Stack State}

This section describes the machine state that \codeindex{exec}(BA\_OS) creates
for new processes. Various language implementations transform this
initial program state to the state required by the language standard.

For example, a C program begins executing at a
function named \code{main} declared as:

\begin{footnotesize}
\begin{verbatim}
    extern int main ( int argc , char *argv[ ] , char* envp[ ] );
\end{verbatim}
\end{footnotesize}

where
\begin{description}
 \item[argc] is a non-negative argument count
 \item[argv] is an array of argument strings, with \code{argv[argc] == 0}
 \item[envp] is an array of environment strings,
             terminated by a null pointer.
\end{description}

When \code{main()} returns its value is passed to \code{exit()} and if
that has been
over-ridden and returns, \code{\_exit()} (which must be immune to user
interposition).

The initial state of the process stack, i.e. when \code{\_start} is called
is shown in table~\ref{initial-stack}.

\begin{table}[H]
\Hrule
\caption{Initial Process Stack}
\label{initial-stack}
\begin{center}
\begin{tabular}{p{14em}|l|p{7em}}
  \multicolumn{1}{c}{Purpose}
         & \multicolumn{1}{c}{Start Address}
         & \multicolumn{1}{c}{Length} \\
\hline
  Unspecified & High Addresses & \\ \hline
  Information block, including argument strings, environment strings,
    auxiliary information ... & & varies \\ \hline
  Unspecified & & \\ \hline
  Null auxiliary vector entry & & 1 fourbyte \\ \hline
  Auxiliary vector entries ... & & 2 fourbytes each \\ \hline
  0 & & fourbyte \\ \hline
  Environment pointers ... & & 1 fourbyte each \\ \hline
  0 & \code{4+4*argc+\ESP} & fourbyte \\ \hline
  Argument pointers & \code{4+\ESP} & argc fourbytes \\ \hline
  Argument count & \ESP & fourbyte \\ \hline
  Undefined & Low Addresses & \\ \hline
    \end{tabular}
  \end{center}
\Hrule
\end{table}

Argument strings, environment strings, and the auxiliary information
appear in no specific order within the information block and they
need not be compactly allocated.

Only the registers listed below have specified values at process
entry:
\begin{description}
 \item[\EBP] The content of this register is unspecified at process
                initialization time, but the user code should mark the
                deepest stack frame by setting the frame pointer to zero.
 \item[\ESP] The stack pointer holds the address of the byte with
                lowest address which is part of the stack. It is
                guaranteed to be 16-byte aligned at process entry.
 \item[\EDX] a function pointer that the application should register
                with \code{atexit}(BA\_OS).
\end{description}

It is unspecified whether 
the data and stack segments are initially mapped with
execute permissions or not.
Applications which need to execute code on the stack or data
segments should take proper precautions, e.g., by calling
\code{mprotect()}.

\subsection{Thread State}

New threads inherit the floating-point state of the parent thread
and the state is private to the thread thereafter.

\subsection{Auxiliary Vector}

The \textindex{auxiliary vector} is an array of the following structures
(ref. table~\ref{fig_auxv_t}),
interpreted according to the \code{a\_type} member.

\begin{table}[H]
\Hrule
\caption{\code{auxv\_t} Type Definition}
\label{fig_auxv_t}
\begin{center}
\begin{verbatim}
 typedef struct
 {
     int a_type;
     union {
         long a_val;
         void *a_ptr;
         void (*a_fnc)();
     } a_un;
 } auxv_t;
\end{verbatim}
\end{center}
\Hrule
\end{table}

The \xARCH ABI uses the auxiliary vector types defined in table~\ref{aux-vec}.

\begin{table}[H]
\Hrule
\caption{Auxiliary Vector Types}
\label{aux-vec}
\begin{center}
\begin{tabular}{l|r|l}
  \multicolumn{1}{c}{Name}
         & \multicolumn{1}{c}{Value}
         & \multicolumn{1}{c}{\code{a\_un}} \\
      \hline
\texttt{AT_NULL}& 0 & ignored\\
\texttt{AT_IGNORE}& 1& ignored\\
\texttt{AT_EXECFD}& 2& \texttt{a_val}\\
\texttt{AT_PHDR}& 3& \texttt{a_ptr}\\
\texttt{AT_PHENT}& 4& \texttt{a_val}\\
\texttt{AT_PHNUM}& 5& \texttt{a_val}\\
\texttt{AT_PAGESZ}& 6& \texttt{a_val}\\
\texttt{AT_BASE}& 7& \texttt{a_ptr}\\
\texttt{AT_FLAGS}& 8& \texttt{a_val}\\
\texttt{AT_ENTRY}& 9& \texttt{a_ptr}\\
\texttt{AT_NOTELF}& 10& \texttt{a_val}\\
\texttt{AT_UID}& 11& \texttt{a_val}\\
\texttt{AT_EUID}& 12& \texttt{a_val}\\
\texttt{AT_GID}& 13& \texttt{a_val}\\
\texttt{AT_EGID}& 14& \texttt{a_val}\\
\texttt{AT_PLATFORM}& 15& \texttt{a_ptr}\\
\texttt{AT_HWCAP}& 16& \texttt{a_val}\\
\texttt{AT_CLKTCK}& 17& \texttt{a_val}\\
\texttt{AT_SECURE}& 23& \texttt{a_val}\\
\texttt{AT_BASE_PLATFORM}& 24& \texttt{a_ptr}\\
\texttt{AT_RANDOM}& 25& \texttt{a_ptr}\\
\texttt{AT_HWCAP2}& 26& \texttt{a_val}\\
\texttt{AT_EXECFN}& 31& \texttt{a_ptr}\\
\hline
    \end{tabular}
  \end{center}
\Hrule
\end{table}

\begin{description}
\item[AT_NULL] The auxiliary vector has no fixed length; instead its
  last entry's \code{a\_type} member has this value.
\item[AT_IGNORE] This type indicates the entry has no meaning. The
  corresponding value of \code{a\_un} is undefined.
\item[AT_EXECFD] At process creation the system may pass control to an
  interpreter program. When this happens, the system places either an
  entry of type \code{AT\_EXECFD} or one of type \code{AT\_PHDR} in the
  auxiliary vector. The entry for type \code{AT\_EXECFD} uses the
  \code{a\_val} member to contain a file descriptor open to read the
  application program's object file.
\item[AT_PHDR] The system may create the memory image of the
  application program before passing control to the interpreter program.
  When this happens, the \code{a\_ptr} member of the \code{AT\_PHDR}
  entry tells the interpreter where to find the program header table in
  the memory image.
\item[AT_PHENT] The \code{a\_val} member of this entry holds the size,
  in bytes, of one entry in the program header table to which the
  \code{AT\_PHDR} entry points.
\item[AT_PHNUM] The \code{a\_val} member of this entry holds the number of
  entries in the program header table to which the \code{AT\_PHDR} entry
  points.
\item[AT_PAGESZ] If present, this entry's \code{a\_val} member gives the
  system page size, in bytes.
\item[AT_BASE] The \code{a\_ptr} member of this entry holds the base address
  at which the interpreter program was loaded into memory. See ``Program
  Header'' in the System V ABI for more information about the base
  address.
\item[AT_FLAGS] If present, the \code{a\_val} member of this entry holds
  one-bit flags.  Bits with undefined semantics are set to zero.
\item[AT_ENTRY] The \code{a\_ptr} member of this entry holds the entry point
  of the application program to which the interpreter program should
  transfer control.
\item[AT_NOTELF] The \code{a_val} member of this entry is non-zero if
  the program is in another format than ELF.
\item[AT_UID] The \code{a_val} member of this entry holds the real
  user id of the process.
\item[AT_EUID] The \code{a_val} member of this entry holds the
  effective user id of the process.
\item[AT_GID] The \code{a_val} member of this entry holds the
  real group id of the process.
\item[AT_EGID] The \code{a_val} member of this entry holds the
  effective group id of the process.
\item[AT_PLATFORM] The \code{a_ptr} member of this entry points to
  a string containing the platform name.
\item[AT_HWCAP] The \code{a_val} member of this entry contains an bitmask
  of CPU features. It mask to the value returned by CPUID 1.EDX.
\item[AT_CLKTCK] The \code{a_val} member of this entry contains the
  frequency at which times() increments.
\item[AT_SECURE] The \code{a_val} member of this entry contains one
  if the program is in secure mode (for example started with suid).
  Otherwise zero.
\item[AT_BASE_PLATFORM] The \code{a_ptr} member of this entry points to
  a string identifying the base architecture platform (which may be different
  from the platform).
\item[AT_RANDOM] The \code{a_ptr} member of this entry points to 16 securely
  generated random bytes.
\item[AT_HWCAP2] The \code{a_val} member of this entry contains the extended
  hardware feature mask. Currently it is 0, but may contain additional feature
  bits in the future.
\item[AT_EXECFN] The \code{a_ptr} member of this entry is a pointer to the
  file name of the executed program.
\end{description}


\section{DWARF Definition}

This section\footnote{This section is structured in a way similar to
  the PowerPC psABI}
defines the Debug With Arbitrary Record Format (DWARF) debugging
format for the \xARCH processor family. The \xARCH ABI does not define
a debug format.  However, all systems that do implement DWARF on \xARCH shall
use the following definitions.

DWARF is a specification developed for symbolic, source-level debugging.
The debugging information format does not favor the design of any
compiler or debugger.  For more information on DWARF,
see \emph{DWARF Debugging Format Standard},
available at: \url{http://www.dwarfstd.org/}.

\subsection{DWARF Release Number}

The DWARF definition requires some machine-specific definitions.
The register number mapping needs to be specified for the \xARCH
registers. In addition, starting with version 3 the DWARF specification
requires processor-specific address class codes to be defined.

\subsection{DWARF Register Number Mapping}

Table~\ref{tbl-reg-num-map}\footnote{The table defines Return Address
  to have a register number, even though the address is stored in
  0(\ESP) and not in a physical register.}  outlines the register
number mapping for the \xARCH processor family.%
\footnote{This document does not define mappings for privileged registers.}%

\begin{table}
\Hrule
\caption{DWARF Register Number Mapping} \label{tbl-reg-num-map}
\begin{center}
\begin{tabular}{l|r|l}
\multicolumn{1}{c}{Register Name}&\multicolumn{1}{c}{Number}&\multicolumn{1}{c}{Abbreviation}\\
\hline
General Purpose Register EAX & 0 &\EAX\\
General Purpose Register ECX & 1 &\ECX\\
General Purpose Register EDX & 2 &\EDX\\
General Purpose Register EBX & 3 &\EBX\\
Stack Pointer Register   ESP & 4 &\ESP\\
Frame Pointer Register   EBP & 5 &\EBP\\
General Purpose Register ESI & 6 &\ESI\\
General Purpose Register EDI & 7 &\EDI\\
Return Address RA            & 8 &\\
Flag Register                   & 9     & \reg{EFLAGS} \\
Reserved                        & 10    &\\
Floating Point Registers 0--7   & 11-18 & \reg{st0}--\reg{st7} \\
Reserved                        & 19-20 &\\
Vector Registers 0--7           & 21-28 & \reg{xmm0}--\reg{xmm7} \\
MMX Registers 0--7              & 29-36 & \reg{mm0}--\reg{mm7} \\
Media Control and Status        & 39   & \reg{mxcsr} \\
Segment Register ES             & 40    & \reg{es} \\
Segment Register CS             & 41    & \reg{cs} \\
Segment Register SS             & 42    & \reg{ss} \\
Segment Register DS             & 43    & \reg{ds} \\
Segment Register FS             & 44    & \reg{fs} \\
Segment Register GS             & 45    & \reg{gs} \\
Reserved                        & 46-47 & \\
Task Register                   & 48    & \reg{tr} \\
LDT Register                    & 49    & \reg{ldtr} \\
Reserved                        & 50-92 & \\
FS Base address                 & 93    & \reg{fs.base} \\
GS Base address                 & 94    & \reg{gs.base} \\
\end{tabular}
\end{center}
\Hrule
\end{table}

\section{Stack Unwind Algorithm}

The stack frames are not self descriptive and where stack unwinding is
desirable (such as for exception handling) additional unwind
information needs to be generated.  The information is stored in an
allocatable section \code{.eh_frame} whose format is identical to
\code{.debug_frame} defined by the DWARF debug information standard,
see \emph{DWARF Debugging Information Format}, with the following
extensions:

\begin{description}
\item[Position independence]

  In order to avoid load time relocations for position independent
  code, the FDE CIE offset pointer should be stored relative to the
  start of CIE table entry.  Frames using this extension of the DWARF
  standard must set the CIE identifier tag to 1.

\item[Outgoing arguments area delta]
  
  To maintain the size of the temporarily allocated outgoing arguments
  area present on the end of the stack (when using \code{push}
  instructions), operation \code{GNU_ARGS_SIZE} (\code{0x2e}) can be
  used.  This operation takes a single \code{uleb128} argument
  specifying the current size.  This information is used to adjust the
  stack frame when jumping into the exception handler of the function
  after unwinding the stack frame.  Additionally the CIE Augmentation
  shall contain an exact specification of the encoding used.  It is
  recommended to use a PC relative encoding whenever possible and
  adjust the size according to the code model used.

\item[CIE Augmentations:]
 
  The augmentation field is formated according to the augmentation
  field formating string stored in the CIE header.
  
  The string may contain the following characters:

\begin{description}
\item[z] Indicates that a \code{uleb128} is present determining the size of
  the augmentation section.
\item[L] Indicates the encoding (and thus presence) of an LSDA pointer in the FDE augmentation.
  
  The data filed consist of single byte specifying the way pointers
  are encoded.  It is a mask of the values specified by the table~
  \ref{tbl-pointer-encoding}.

\begin{table}
\Hrule
\caption{Pointer Encoding Specification Byte} \label{tbl-pointer-encoding}
\begin{center}
\begin{tabular}{r|l}
\multicolumn{1}{c}{Mask}&\multicolumn{1}{c}{Meaning}\\
\hline
0x1 & Values are stored as \code{uleb128} or \code{sleb128} type (according to flag 0x8)\\
0x2 & Values are stored as 2 bytes wide integers (\code{udata2} or \code{sdata2})\\
0x3 & Values are stored as 4 bytes wide integers (\code{udata4} or \code{sdata4})\\
0x4 & Values are stored as 8 bytes wide integers (\code{udata8} or \code{sdata8})\\
0x8 & Values are signed\\
0x10 & Values are PC relative\\
0x20 & Values are text section relative\\
0x30 & Values are data section relative\\
0x40 & Values are relative to the start of function\\
\end{tabular}
\end{center}
\Hrule
\end{table}

The default DWARF pointer encoding (direct 4-byte absolute pointers)
is represented by value 0.

\item[R]  
  Indicates a non-default pointer encoding for FDE code pointers.  The
  formating is represented by a single byte in the same way as in the
  `L' command.

\item[P]  
  Indicates the presence and an encoding of a language personality
  routine in the CIE augmentation.  The encoding is represented by a
  single byte in the same way as in the 'L' command followed by a
  pointer to the personality function encoded by the specified
  encoding.

\end{description}

When the augmentation is present, the first command must always be
`\code{z}' to allow easy skipping of the information.

\end{description}

In order to simplify manipulation of the unwind tables, the runtime
library provide higher level API to stack unwinding mechanism, for
details see section~\ref{unwindlib}.

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "abi"
%%% End:
